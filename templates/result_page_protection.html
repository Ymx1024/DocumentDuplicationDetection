<!-- ç»“æœé¡µé¢ä¿æŠ¤è„šæœ¬ - é˜²æ­¢æ„å¤–åˆ·æ–°å’Œè¡¨å•é‡å¤æäº¤ -->
<script>
// é˜²æ­¢è¡¨å•é‡å¤æäº¤å’Œç»“æœä¸¢å¤±çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ
(function() {
    // é¡µé¢çŠ¶æ€ç®¡ç†
    let pageLoaded = true;
    let isLeavingIntentionally = false;
    
    // åˆ›å»ºç¾è§‚çš„ç¡®è®¤å¯¹è¯æ¡†
    function showCustomConfirm(title, message, onConfirm, onCancel) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease;
        `;
        
        dialog.innerHTML = `
            <div style="margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">${title}</h3>
                <p style="margin: 0; color: #666; line-height: 1.5; font-size: 16px;">${message}</p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button id="confirmBtn" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: background 0.3s;
                ">ç¡®è®¤ç¦»å¼€</button>
                <button id="cancelBtn" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: background 0.3s;
                ">å–æ¶ˆ</button>
            </div>
        `;
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('confirmBtn').onclick = function() {
            document.body.removeChild(modal);
            document.head.removeChild(style);
            if (onConfirm) onConfirm();
        };
        
        document.getElementById('cancelBtn').onclick = function() {
            document.body.removeChild(modal);
            document.head.removeChild(style);
            if (onCancel) onCancel();
        };
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.onclick = function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                if (onCancel) onCancel();
            }
        };
        
        // ESCé”®å…³é—­
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                document.removeEventListener('keydown', escHandler);
                if (onCancel) onCancel();
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ç›‘å¬é¡µé¢åˆ·æ–°/å…³é—­äº‹ä»¶
    window.addEventListener('beforeunload', function(e) {
        if (pageLoaded && !isLeavingIntentionally) {
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ›¿ä»£é»˜è®¤æµè§ˆå™¨æç¤º
            e.preventDefault();
            e.returnValue = ''; // ç°ä»£æµè§ˆå™¨è¦æ±‚è¿”å›ç©ºå­—ç¬¦ä¸²
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            showCustomConfirm(
                'âš ï¸ ç¦»å¼€é¡µé¢ç¡®è®¤',
                'ç¦»å¼€æ­¤é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦ç¦»å¼€é¡µé¢å—ï¼Ÿ</strong>',
                function() {
                    // ç”¨æˆ·ç¡®è®¤ç¦»å¼€
                    isLeavingIntentionally = true;
                    // ä¸æ‰§è¡Œå…·ä½“æ“ä½œï¼Œè®©æµè§ˆå™¨è‡ªç„¶å¤„ç†
                },
                function() {
                    // ç”¨æˆ·å–æ¶ˆç¦»å¼€
                    console.log('ç”¨æˆ·å–æ¶ˆäº†ç¦»å¼€é¡µé¢');
                }
            );
            
            return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²ä»¥é˜»æ­¢é»˜è®¤è¡Œä¸º
        }
    });
    
    // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶
    window.addEventListener('unload', function() {
        pageLoaded = false;
    });
    
    // DOMåŠ è½½å®Œæˆåçš„å¤„ç†
    document.addEventListener('DOMContentLoaded', function() {
        // é˜»æ­¢æ‰€æœ‰è¡¨å•çš„æ„å¤–æäº¤
        const forms = document.querySelectorAll('form');
        forms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                showCustomConfirm(
                    'é‡æ–°æäº¤ç¡®è®¤',
                    'æ­¤é¡µé¢ä¸ºç»“æœå±•ç¤ºé¡µé¢ï¼Œé‡æ–°æäº¤å°†é‡å¤æ‰§è¡Œæ¯”å¯¹ä»»åŠ¡ï¼Œæµªè´¹æœåŠ¡å™¨èµ„æºã€‚<br><br><strong>å»ºè®®ï¼š</strong>å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µã€‚',
                    function() {
                        // ç”¨æˆ·ç¡®è®¤é‡æ–°æäº¤
                        isLeavingIntentionally = true;
                        form.submit();
                    }
                );
                return false;
            });
        });
        
        // ä¸ºè¿”å›é“¾æ¥æ·»åŠ å¤„ç†
        const backLinks = document.querySelectorAll('a[href="/"], a[href="' + window.location.origin + '/"]');
        backLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                isLeavingIntentionally = true;
                pageLoaded = false;
            });
        });
        
        // æ·»åŠ é¡µé¢é¡¶éƒ¨æç¤ºæ¡
        const notice = document.createElement('div');
        notice.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 0;
            text-align: center;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        `;
        notice.innerHTML = `
            <span style="margin-right: 10px;">ğŸ’¡</span>
            <strong>æç¤ºï¼š</strong>æ­¤é¡µé¢ä¸ºæ¯”å¯¹ç»“æœå±•ç¤ºé¡µé¢ï¼Œåˆ·æ–°å°†å¯¼è‡´ç»“æœä¸¢å¤±
            <span style="margin-left: 15px; font-size: 12px; opacity: 0.9;">å¦‚éœ€æ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ</span>
        `;
        
        document.body.appendChild(notice);
        
        // è°ƒæ•´é¡µé¢å†…å®¹çš„ä¸Šè¾¹è·ï¼Œé¿å…è¢«æç¤ºæ¡é®æŒ¡
        const body = document.body;
        if (body) {
            body.style.paddingTop = '50px';
        }
    });
    
        // é”®ç›˜å¿«æ·é”®å¤„ç†
        document.addEventListener('keydown', function(e) {
            // F5 æˆ– Ctrl+R åˆ·æ–°æ—¶çš„ç¡®è®¤
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                showCustomConfirm(
                    'ğŸ”„ åˆ·æ–°é¡µé¢ç¡®è®¤',
                    'åˆ·æ–°é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦åˆ·æ–°é¡µé¢å—ï¼Ÿ</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        location.reload();
                    }
                );
                return false;
            }
            
            // Ctrl+W å…³é—­æ ‡ç­¾é¡µæ—¶çš„ç¡®è®¤
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                showCustomConfirm(
                    'âŒ å…³é—­é¡µé¢ç¡®è®¤',
                    'å…³é—­é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœæ°¸ä¹…ä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦å…³é—­é¡µé¢å—ï¼Ÿ</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        window.close();
                    }
                );
                return false;
            }
        });
    
    // æµè§ˆå™¨å†å²ç®¡ç†
    if (window.history && window.history.replaceState) {
        // æ›¿æ¢å½“å‰å†å²çŠ¶æ€ï¼Œé¿å…è¡¨å•é‡æ–°æäº¤
        const newUrl = window.location.href.split('?')[0];
        window.history.replaceState(
            { page: 'result' }, 
            document.title, 
            newUrl
        );
    }
    
    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            sessionStorage.setItem('resultPageVisited', 'true');
            sessionStorage.setItem('resultPageTime', Date.now().toString());
        } else if (document.visibilityState === 'visible') {
            const visitTime = sessionStorage.getItem('resultPageTime');
            if (visitTime) {
                const timeDiff = Date.now() - parseInt(visitTime);
                if (timeDiff > 300000) { // 5åˆ†é’Ÿ
                    showCustomConfirm(
                        'é¡µé¢å·²è¿‡æœŸ',
                        'æ‚¨ç¦»å¼€æ­¤é¡µé¢å·²è¶…è¿‡5åˆ†é’Ÿï¼Œç»“æœå¯èƒ½å·²è¿‡æœŸã€‚<br><br>å»ºè®®è¿”å›é¦–é¡µè¿›è¡Œæ–°çš„æ¯”å¯¹ã€‚',
                        function() {
                            isLeavingIntentionally = true;
                            window.location.href = '/';
                        }
                    );
                }
            }
        }
    });
    
    console.log('ğŸ›¡ï¸ ç»“æœé¡µé¢ä¿æŠ¤å·²å¯ç”¨ï¼šé˜²æ­¢æ„å¤–åˆ·æ–°ã€è¡¨å•é‡å¤æäº¤å’Œç»“æœä¸¢å¤±');
})();
</script>
