<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文件比对结果</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .container { 
            display: flex; 
            gap: 20px;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .right-panel {
            width: 20%;
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .preview-container { 
            display: flex; 
            gap: 20px;
            margin-top: 20px;
            flex: 1;
            min-height: 0;
        }
        .preview { 
            flex: 1;
            overflow: hidden; /* 只让内部 .file-content 滚动，header 固定在内容上层 */
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #fafafa;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        .highlight-modified { background-color: #cce7ff; border-left: 4px solid #007bff; }
        .highlight-added { background-color: #d4edda; border-left: 4px solid #28a745; }
        .highlight-deleted { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .diff-box { 
            cursor: pointer; 
            margin-bottom: 15px; 
            padding: 12px; 
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        .diff-box:hover {
            background: #e9ecef;
            border-color: #dee2e6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .diff-type {
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 8px;
            display: inline-block;
        }
        .diff-type.modified { background: #cce7ff; color: #0056b3; }
        .diff-type.added { background: #d4edda; color: #155724; }
        .diff-type.deleted { background: #f8d7da; color: #721c24; }
        .diff-content {
            font-size: 13px;
            line-height: 1.4;
            word-break: break-word;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        .diff-content.expanded {
            max-height: none;
        }
        .expand-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 11px;
            cursor: pointer;
            padding: 0;
            margin-top: 5px;
        }
        .similarity-score {
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        /* 相似度颜色分级 */
        .similarity-excellent {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .similarity-good {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
        
        .similarity-medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .similarity-low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .similarity-very-low {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .checkbox-container input {
            margin-right: 8px;
        }
        .error { 
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .top-header h1 {
            margin: 0;
            flex: 1;
        }
        .top-right-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .top-right-controls .similarity-score {
            margin-bottom: 0;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        /* 确保所有相似度框都有hover效果 */
        .similarity-score:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .top-right-controls .controls {
            margin-bottom: 0;
            padding: 8px 12px;
        }
        .fixed-header {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        .file-header {
            /* 让文件头部成为内容的第一行，随内容一起滚动，不悬浮 */
            position: static;
            background: white;
            flex-shrink: 0;
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .file-content {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }
        .diff-list {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }
        .file-name {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const originalScroll = document.querySelector('.original-preview .file-content');
            const comparisonScroll = document.querySelector('.comparison-preview .file-content');
            const syncScroll = document.getElementById('sync-scroll');

            // 同步滚动处理函数
            function syncScrollHandler(e) {
                if (syncScroll && syncScroll.checked) {
                    const other = e.target === originalScroll ? comparisonScroll : originalScroll;
                    // 暂时移除事件监听，避免循环触发
                    other.removeEventListener('scroll', syncScrollHandler);
                    other.scrollTop = e.target.scrollTop;
                    other.scrollLeft = e.target.scrollLeft;
                    // 重新添加事件监听
                    setTimeout(() => {
                        other.addEventListener('scroll', syncScrollHandler);
                    }, 10);
                }
            }

            // 初始化同步滚动功能
            function initSyncScroll() {
                if (syncScroll && syncScroll.checked && originalScroll && comparisonScroll) {
                    originalScroll.addEventListener('scroll', syncScrollHandler);
                    comparisonScroll.addEventListener('scroll', syncScrollHandler);
                }
            }

            // 同步滚动切换事件
            if (syncScroll) {
                syncScroll.addEventListener('change', () => {
                    // 移除现有的监听器
                    originalScroll && originalScroll.removeEventListener('scroll', syncScrollHandler);
                    comparisonScroll && comparisonScroll.removeEventListener('scroll', syncScrollHandler);
                    
                    if (syncScroll.checked) {
                        // 重新添加监听器
                        originalScroll && originalScroll.addEventListener('scroll', syncScrollHandler);
                        comparisonScroll && comparisonScroll.addEventListener('scroll', syncScrollHandler);
                    }
                });

                // 页面加载完成后立即初始化同步滚动（如果默认勾选）
                initSyncScroll();
            }

            // 根据相似度设置颜色
            function setSimilarityColor() {
                const similarityElement = document.querySelector('.similarity-score');
                if (!similarityElement) return;
                
                const similarityText = similarityElement.textContent;
                const similarityMatch = similarityText.match(/(\d+\.?\d*)/);
                if (!similarityMatch) return;
                
                const similarity = parseFloat(similarityMatch[1]);
                
                // 移除所有相似度类
                similarityElement.classList.remove('similarity-excellent', 'similarity-good', 'similarity-medium', 'similarity-low', 'similarity-very-low');
                
                // 根据相似度添加对应类
                if (similarity >= 95) {
                    similarityElement.classList.add('similarity-excellent');
                    similarityElement.title = '优秀：文档高度相似';
                } else if (similarity >= 85) {
                    similarityElement.classList.add('similarity-good');
                    similarityElement.title = '良好：文档相似度较高';
                } else if (similarity >= 70) {
                    similarityElement.classList.add('similarity-medium');
                    similarityElement.title = '中等：文档有一定相似度';
                } else if (similarity >= 50) {
                    similarityElement.classList.add('similarity-low');
                    similarityElement.title = '较低：文档相似度不高';
                } else {
                    similarityElement.classList.add('similarity-very-low');
                    similarityElement.title = '很低：文档差异较大';
                }
            }

            // 初始化相似度颜色
            setSimilarityColor();

            // 初始化高亮显示状态
            function initHighlights() {
                document.querySelectorAll('.ignore-diff').forEach(checkbox => {
                    const diffId = checkbox.dataset.diffId;
                    const diffType = checkbox.dataset.diffType;
                    const highlights = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                    
                    console.log(`初始化高亮: diffId=${diffId}, diffType=${diffType}, 找到${highlights.length}个元素`);
                    
                    // 根据勾选框状态设置高亮
                    highlights.forEach(elem => {
                        if (checkbox.checked) {
                            // 兼容英文类型
                            const typeKey = (diffType === '修改' ? 'modified' : diffType === '新增' ? 'added' : diffType === '删除' ? 'deleted' : diffType);
                            elem.classList.add(`highlight-${typeKey}`);
                            console.log(`添加高亮类: highlight-${diffType}`);
                        } else {
                            const typeKey = (diffType === '修改' ? 'modified' : diffType === '新增' ? 'added' : diffType === '删除' ? 'deleted' : diffType);
                            elem.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                });
            }

            // 高亮切换事件（按文件类型分流）
            function applyHighlightForExcel(e) {
                const diffId = e.target.dataset.diffId;
                const diffType = e.target.dataset.diffType;
                const highlights = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                highlights.forEach(elem => {
                    const typeKey = (diffType === '修改' ? 'modified' : diffType === '新增' ? 'added' : diffType === '删除' ? 'deleted' : diffType);
                    if (e.target.checked) elem.classList.add(`highlight-${typeKey}`);
                    else elem.classList.remove(`highlight-${typeKey}`);
                });
            }

            function applyHighlightForWord(e) {
                const diffType = e.target.dataset.diffType;
                const startOrig = parseInt(e.target.dataset.startIdxOrig, 10);
                const endOrig = parseInt(e.target.dataset.endIdxOrig, 10);
                const startNew = parseInt(e.target.dataset.startIdxNew, 10);
                const endNew = parseInt(e.target.dataset.endIdxNew, 10);
                const typeKey = (diffType === '修改' ? 'modified' : diffType === '新增' ? 'added' : diffType === '删除' ? 'deleted' : diffType);

                const origLines = document.querySelectorAll('.original-preview .line-content');
                const newLines = document.querySelectorAll('.comparison-preview .line-content');

                // 删除：仅原文区间
                if (typeKey === 'deleted') {
                    origLines.forEach((el, idx) => {
                        if (idx >= startOrig && idx < endOrig) {
                            e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                    return;
                }

                // 新增：仅新文区间
                if (typeKey === 'added') {
                    newLines.forEach((el, idx) => {
                        if (idx >= startNew && idx < endNew) {
                            e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                    return;
                }

                // 修改：两侧区间
                origLines.forEach((el, idx) => {
                    if (idx >= startOrig && idx < endOrig) {
                        e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                    }
                });
                newLines.forEach((el, idx) => {
                    if (idx >= startNew && idx < endNew) {
                        e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                    }
                });
            }

            const container = document.querySelector('.container');
            const fileType = container ? container.getAttribute('data-filetype') : 'text';
            document.querySelectorAll('.ignore-diff').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (fileType === 'word') applyHighlightForWord(e);
                    else applyHighlightForExcel(e);
                });
                // 初次加载时同步一次，确保勾选状态与类一致
                const evt = { target: checkbox };
                if (fileType === 'word') applyHighlightForWord(evt);
                else applyHighlightForExcel(evt);
            });

            // 页面加载完成后初始化高亮状态
            setTimeout(() => {
                console.log('开始检查DOM结构...');
                const allDiffElements = document.querySelectorAll('[data-diff-id]');
                console.log(`找到 ${allDiffElements.length} 个带有data-diff-id的元素`);
                
                const allCheckboxes = document.querySelectorAll('.ignore-diff');
                console.log(`找到 ${allCheckboxes.length} 个高亮勾选框`);
                
                allCheckboxes.forEach((checkbox, index) => {
                    const diffId = checkbox.dataset.diffId;
                    const diffType = checkbox.dataset.diffType;
                    const matchingElements = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                    console.log(`勾选框${index}: diffId=${diffId}, type=${diffType}, 找到${matchingElements.length}个匹配元素`);
                    
                    // 检查具体在哪个区域找到了元素
                    const originalElements = document.querySelectorAll(`.original-preview [data-diff-id="${diffId}"]`);
                    const comparisonElements = document.querySelectorAll(`.comparison-preview [data-diff-id="${diffId}"]`);
                    console.log(`  - 原始文件区域: ${originalElements.length}个, 对比文件区域: ${comparisonElements.length}个`);
                });
                
                initHighlights();
            }, 1000);

            // 跳转到差异行
            document.querySelectorAll('.diff-box').forEach(box => {
                box.addEventListener('click', () => {
                    const diffId = box.dataset.diffId;
                    console.log(`点击差异框，diffId: ${diffId}`);
                    
                    const container = document.querySelector('.container');
                    const fileType = container ? container.getAttribute('data-filetype') : 'text';
                    let targetOriginal = null;
                    let targetComparison = null;

                    if (fileType === 'word') {
                        // Word：优先定位区间内第一个具有匹配文本的行，回退到起始行
                        const startOrig = parseInt(box.dataset.startIdxOrig, 10);
                        const endOrig = parseInt(box.dataset.endIdxOrig, 10);
                        const startNew = parseInt(box.dataset.startIdxNew, 10);
                        const endNew = parseInt(box.dataset.endIdxNew, 10);
                        const tryFindInRange = (selectorBase, s, e) => {
                            for (let i = s; i < e; i++) {
                                const el = document.querySelector(`${selectorBase}[data-line-num="${i}"]`);
                                if (el && el.textContent && el.textContent.trim()) return el;
                            }
                            return null;
                        };
                        targetOriginal = tryFindInRange('.original-preview .line-content', startOrig, endOrig) || document.querySelector(`.original-preview .line-content[data-line-num="${startOrig}"]`);
                        targetComparison = tryFindInRange('.comparison-preview .line-content', startNew, endNew) || document.querySelector(`.comparison-preview .line-content[data-line-num="${startNew}"]`);
                    } else {
                        // Excel：沿用 data-diff-id 精确定位
                        targetOriginal = document.querySelector(`.original-preview .line-content[data-diff-id="${diffId}"]`);
                        targetComparison = document.querySelector(`.comparison-preview .line-content[data-diff-id="${diffId}"]`);
                    }
                    
                    // 如果没找到，尝试旧的选择器作为备选
                    if (!targetOriginal) targetOriginal = document.querySelector(`.original-preview [data-diff-id="${diffId}"]`);
                    if (!targetComparison) targetComparison = document.querySelector(`.comparison-preview [data-diff-id="${diffId}"]`);
                    
                    console.log(`🎯 最终找到 - 原始行: ${targetOriginal ? '是' : '否'}, 对比行: ${targetComparison ? '是' : '否'}`);
                    
                    // 获取差异类型进行特殊处理
                    const diffTypeBadge = box.querySelector('.diff-type');
                    const diffType = diffTypeBadge && diffTypeBadge.classList.contains('modified') ? '修改'
                        : diffTypeBadge && diffTypeBadge.classList.contains('added') ? '新增'
                        : diffTypeBadge && diffTypeBadge.classList.contains('deleted') ? '删除'
                        : (box.dataset.diffType || box.querySelector('.diff-type').textContent.trim());
                    console.log(`🎯 差异类型: ${diffType}`);
                    
                    // 根据差异类型选择跳转策略
                    if (diffType === '删除') {
                        if (targetOriginal) {
                            targetOriginal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            attemptAdvancedSearch(diffId);
                        }
                    } else if (diffType === '新增') {
                        if (targetComparison) {
                            targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            attemptAdvancedSearch(diffId);
                        }
                    } else {
                        if (fileType === 'word') {
                            // Word：优先滚动到区间起始行，保持两侧一致
                            const startOrig = parseInt(box.dataset.startIdxOrig, 10);
                            const startNew = parseInt(box.dataset.startIdxNew, 10);
                            const oEl = document.querySelector(`.original-preview .line-content[data-line-num="${startOrig}"]`);
                            const nEl = document.querySelector(`.comparison-preview .line-content[data-line-num="${startNew}"]`);
                            if (oEl) oEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            else if (nEl) nEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            else attemptAdvancedSearch(diffId);
                        } else {
                            if (targetOriginal) {
                                targetOriginal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                const syncScrollEnabled = document.getElementById('sync-scroll').checked;
                                if (!syncScrollEnabled && targetComparison) {
                                    setTimeout(() => {
                                        targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 100);
                                }
                            } else if (targetComparison) {
                                targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                attemptAdvancedSearch(diffId);
                            }
                        }
                    }
                });
            });

            // 高级搜索函数：当常规方法找不到元素时使用
            function attemptAdvancedSearch(diffId) {
                console.log(`🔍 开始高级搜索，diffId: ${diffId}`);
                
                // 搜索策略1：通过包含data-diff-id的任何元素
                const allElements = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                console.log(`🔍 策略1找到 ${allElements.length} 个元素`);
                
                if (allElements.length > 0) {
                    const firstElement = allElements[0];
                    firstElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // 搜索策略2：通过差异列表项查找相关元素
                const diffBoxes = document.querySelectorAll(`.diff-box[data-diff-id="${diffId}"]`);
                console.log(`🔍 策略2找到 ${diffBoxes.length} 个差异框`);
                
                if (diffBoxes.length > 0) {
                    diffBoxes[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // 最后的提示
                console.log('🔍 所有搜索策略都失败了');
                alert('无法定位到对应的差异位置，这可能是由于DOM结构问题。请尝试刷新页面或联系技术支持。');
            }

            // 展开/收起差异内容
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = btn.previousElementSibling;
                    content.classList.toggle('expanded');
                    btn.textContent = content.classList.contains('expanded') ? '收起' : '展开';
                });
            });
        });
    </script>
</head>
<body>
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    {% if results %}
    <div class="container" data-filetype="{% set _ext = (results.original_filename or '')|lower %}{% if _ext.endswith('.doc') or _ext.endswith('.docx') %}word{% elif _ext.endswith('.xls') or _ext.endswith('.xlsx') %}excel{% else %}text{% endif %}">
        <div class="left-panel">
            <div class="top-header">
                <h1>文件比对结果</h1>
                <div class="top-right-controls">
                    <div class="similarity-score">
                        相似度: {{ results.similarity }}%
                    </div>
                    <div class="controls">
                        <div class="checkbox-container">
                            <input type="checkbox" id="sync-scroll" checked>
                            <label for="sync-scroll">同步滚动</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-container">
                <div class="preview original-preview">
                    <div class="file-header">
                        <div class="file-name">原始文件: {{ results.original_filename }}</div>
                    </div>
                    <div class="file-content">
                        {% for line in results.original_lines %}
                            {% set idx = loop.index0 %}
                            {% set diff = results.differences | selectattr('start_idx_orig','le', idx) | selectattr('end_idx_orig','gt', idx) | first %}
                            <div class="line-content{% if diff %} highlight-{{ diff.type }}{% endif %}"
                                 data-line-num="{{ idx }}"{% if diff %} data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"{% endif %}>{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="preview comparison-preview">
                    <div class="file-header">
                        <div class="file-name">比对文件: {{ results.comparison_filename }}</div>
                    </div>
                    <div class="file-content">
                        {% for line in results.comparison_lines %}
                            {% set idx = loop.index0 %}
                            {% set diff = results.differences | selectattr('start_idx_new','le', idx) | selectattr('end_idx_new','gt', idx) | first %}
                            <div class="line-content{% if diff %} highlight-{{ diff.type }}{% endif %}"
                                 data-line-num="{{ idx }}"{% if diff %} data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"{% endif %}>{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="fixed-header">
                <div class="section-title">
                    文件差异 ({{ results.differences|length }} 处)
                </div>
            </div>
            
            <div class="diff-list">
                {% for diff in results.differences %}
                    <div class="diff-box" data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"
                         data-start-idx-orig="{{ diff.start_idx_orig }}" data-end-idx-orig="{{ diff.end_idx_orig }}"
                         data-start-idx-new="{{ diff.start_idx_new }}" data-end-idx-new="{{ diff.end_idx_new }}">
                        <div class="diff-type {{ diff.type }}">
                            {% if diff.type == 'modified' %}修改
                            {% elif diff.type == 'added' %}新增
                            {% elif diff.type == 'deleted' %}删除
                            {% endif %}
                        </div>
                        <div class="diff-content">
                            {% if diff.type == 'modified' %}
                                <strong>原文:</strong> {{ diff.original }}<br>
                                <strong>新文:</strong> {{ diff.new }}
                            {% elif diff.type == 'added' %}
                                <strong>新增内容:</strong> {{ diff.new }}
                            {% elif diff.type == 'deleted' %}
                                <strong>删除内容:</strong> {{ diff.original }}
                            {% endif %}
                        </div>
                        {% if (diff.original and diff.original|length > 100) or (diff.new and diff.new|length > 100) %}
                            <button class="expand-btn">展开</button>
                        {% endif %}
                        <div class="checkbox-container" style="margin-top: 8px;">
                            <input type="checkbox" class="ignore-diff" data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"
                                   data-start-idx-orig="{{ diff.start_idx_orig }}" data-end-idx-orig="{{ diff.end_idx_orig }}"
                                   data-start-idx-new="{{ diff.start_idx_new }}" data-end-idx-new="{{ diff.end_idx_new }}" checked>
                            <label>高亮显示</label>
                        </div>
                    </div>
                {% endfor %}
                
                {% if not results.differences %}
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        <p>未发现差异</p>
                        <p>两个文件内容完全相同</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
        <div style="text-align: center; padding: 40px;">
            <h1>文件比对</h1>
            <p><a href="/">返回上传页面</a></p>
        </div>
    {% endif %}
    
    <!-- 结果页面保护脚本 - 防止意外刷新和表单重复提交 -->
    <script>
    // 防止表单重复提交和结果丢失的完整解决方案
    (function() {
        // 页面状态管理
        let pageLoaded = true;
        let isLeavingIntentionally = false;
        
        // 创建美观的确认对话框
        function showCustomConfirm(title, message, onConfirm, onCancel) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 90%;
                text-align: center;
                animation: fadeIn 0.3s ease;
            `;
            
            dialog.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">${title}</h3>
                    <p style="margin: 0; color: #666; line-height: 1.5; font-size: 16px;">${message}</p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="confirmBtn" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background 0.3s;
                    ">确认离开</button>
                    <button id="cancelBtn" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background 0.3s;
                    ">取消</button>
                </div>
            `;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.9); }
                    to { opacity: 1; transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // 按钮事件
            document.getElementById('confirmBtn').onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                if (onConfirm) onConfirm();
            };
            
            document.getElementById('cancelBtn').onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                if (onCancel) onCancel();
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                    if (onCancel) onCancel();
                }
            };
            
            // ESC键关闭
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                    document.removeEventListener('keydown', escHandler);
                    if (onCancel) onCancel();
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // 监听页面刷新/关闭事件
        window.addEventListener('beforeunload', function(e) {
            if (pageLoaded && !isLeavingIntentionally) {
                // 使用自定义确认对话框替代默认浏览器提示
                e.preventDefault();
                e.returnValue = ''; // 现代浏览器要求返回空字符串
                
                // 显示自定义确认对话框
                showCustomConfirm(
                    '⚠️ 离开页面确认',
                    '离开此页面将导致比对结果丢失！<br><br><strong>💡 建议操作：</strong><br>• 如需保存结果，请先截图或复制重要信息<br>• 如需进行新的比对，请返回首页<br><br><strong>⚠️ 确定要离开页面吗？</strong>',
                    function() {
                        // 用户确认离开
                        isLeavingIntentionally = true;
                        // 不执行具体操作，让浏览器自然处理
                    },
                    function() {
                        // 用户取消离开
                        console.log('用户取消了离开页面');
                    }
                );
                
                return ''; // 返回空字符串以阻止默认行为
            }
        });
        
        // 监听页面卸载事件
        window.addEventListener('unload', function() {
            pageLoaded = false;
        });
        
        // DOM加载完成后的处理
        document.addEventListener('DOMContentLoaded', function() {
            // 阻止所有表单的意外提交
            const forms = document.querySelectorAll('form');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    showCustomConfirm(
                        '重新提交确认',
                        '此页面为结果展示页面，重新提交将重复执行比对任务，浪费服务器资源。<br><br><strong>建议：</strong>如需进行新的比对，请返回首页。',
                        function() {
                            // 用户确认重新提交
                            isLeavingIntentionally = true;
                            form.submit();
                        }
                    );
                    return false;
                });
            });
            
            // 为返回链接添加处理
            const backLinks = document.querySelectorAll('a[href="/"], a[href="' + window.location.origin + '/"]');
            backLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    isLeavingIntentionally = true;
                    pageLoaded = false;
                });
            });
            
            // 添加页面顶部提示条
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 8px 0;
                text-align: center;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            notice.innerHTML = `
                <span style="margin-right: 10px;">💡</span>
                <strong>提示：</strong>此页面为比对结果展示页面，刷新将导致结果丢失
                <span style="margin-left: 15px; font-size: 12px; opacity: 0.9;">如需新的比对，请返回首页</span>
            `;
            
            document.body.appendChild(notice);
            
            // 调整页面内容的上边距，避免被提示条遮挡
            const body = document.body;
            if (body) {
                body.style.paddingTop = '50px';
            }
        });
        
        // 键盘快捷键处理
        document.addEventListener('keydown', function(e) {
            // F5 或 Ctrl+R 刷新时的确认
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                showCustomConfirm(
                    '🔄 刷新页面确认',
                    '刷新页面将导致比对结果丢失！<br><br><strong>💡 建议操作：</strong><br>• 如需保存结果，请先截图或复制重要信息<br>• 如需进行新的比对，请返回首页<br><br><strong>⚠️ 确定要刷新页面吗？</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        location.reload();
                    }
                );
                return false;
            }
            
            // Ctrl+W 关闭标签页时的确认
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                showCustomConfirm(
                    '❌ 关闭页面确认',
                    '关闭页面将导致比对结果永久丢失！<br><br><strong>💡 建议操作：</strong><br>• 如需保存结果，请先截图或复制重要信息<br>• 如需进行新的比对，请返回首页<br><br><strong>⚠️ 确定要关闭页面吗？</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        window.close();
                    }
                );
                return false;
            }
        });
        
        // 浏览器历史管理
        if (window.history && window.history.replaceState) {
            // 替换当前历史状态，避免表单重新提交
            const newUrl = window.location.href.split('?')[0];
            window.history.replaceState(
                { page: 'result' }, 
                document.title, 
                newUrl
            );
        }
        
        console.log('🛡️ 结果页面保护已启用：防止意外刷新、表单重复提交和结果丢失');
    })();
    </script>
</body>
</html>