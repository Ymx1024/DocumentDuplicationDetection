<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ–‡ä»¶æ¯”å¯¹ç»“æœ</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .container { 
            display: flex; 
            gap: 20px;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .right-panel {
            width: 20%;
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .preview-container { 
            display: flex; 
            gap: 20px;
            margin-top: 20px;
            flex: 1;
            min-height: 0;
        }
        .preview { 
            flex: 1;
            overflow: hidden; /* åªè®©å†…éƒ¨ .file-content æ»šåŠ¨ï¼Œheader å›ºå®šåœ¨å†…å®¹ä¸Šå±‚ */
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: #fafafa;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        .highlight-modified { background-color: #cce7ff; border-left: 4px solid #007bff; }
        .highlight-added { background-color: #d4edda; border-left: 4px solid #28a745; }
        .highlight-deleted { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .diff-box { 
            cursor: pointer; 
            margin-bottom: 15px; 
            padding: 12px; 
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        .diff-box:hover {
            background: #e9ecef;
            border-color: #dee2e6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .diff-type {
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 8px;
            display: inline-block;
        }
        .diff-type.modified { background: #cce7ff; color: #0056b3; }
        .diff-type.added { background: #d4edda; color: #155724; }
        .diff-type.deleted { background: #f8d7da; color: #721c24; }
        .diff-content {
            font-size: 13px;
            line-height: 1.4;
            word-break: break-word;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        .diff-content.expanded {
            max-height: none;
        }
        .expand-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 11px;
            cursor: pointer;
            padding: 0;
            margin-top: 5px;
        }
        .similarity-score {
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        /* ç›¸ä¼¼åº¦é¢œè‰²åˆ†çº§ */
        .similarity-excellent {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .similarity-good {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }
        
        .similarity-medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .similarity-low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .similarity-very-low {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .checkbox-container input {
            margin-right: 8px;
        }
        .error { 
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .top-header h1 {
            margin: 0;
            flex: 1;
        }
        .top-right-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .top-right-controls .similarity-score {
            margin-bottom: 0;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        /* ç¡®ä¿æ‰€æœ‰ç›¸ä¼¼åº¦æ¡†éƒ½æœ‰hoveræ•ˆæœ */
        .similarity-score:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .top-right-controls .controls {
            margin-bottom: 0;
            padding: 8px 12px;
        }
        .fixed-header {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        .file-header {
            /* è®©æ–‡ä»¶å¤´éƒ¨æˆä¸ºå†…å®¹çš„ç¬¬ä¸€è¡Œï¼Œéšå†…å®¹ä¸€èµ·æ»šåŠ¨ï¼Œä¸æ‚¬æµ® */
            position: static;
            background: white;
            flex-shrink: 0;
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            border-radius: 4px;
        }
        .file-content {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }
        .diff-list {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }
        .file-name {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const originalScroll = document.querySelector('.original-preview .file-content');
            const comparisonScroll = document.querySelector('.comparison-preview .file-content');
            const syncScroll = document.getElementById('sync-scroll');

            // åŒæ­¥æ»šåŠ¨å¤„ç†å‡½æ•°
            function syncScrollHandler(e) {
                if (syncScroll && syncScroll.checked) {
                    const other = e.target === originalScroll ? comparisonScroll : originalScroll;
                    // æš‚æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬ï¼Œé¿å…å¾ªç¯è§¦å‘
                    other.removeEventListener('scroll', syncScrollHandler);
                    other.scrollTop = e.target.scrollTop;
                    other.scrollLeft = e.target.scrollLeft;
                    // é‡æ–°æ·»åŠ äº‹ä»¶ç›‘å¬
                    setTimeout(() => {
                        other.addEventListener('scroll', syncScrollHandler);
                    }, 10);
                }
            }

            // åˆå§‹åŒ–åŒæ­¥æ»šåŠ¨åŠŸèƒ½
            function initSyncScroll() {
                if (syncScroll && syncScroll.checked && originalScroll && comparisonScroll) {
                    originalScroll.addEventListener('scroll', syncScrollHandler);
                    comparisonScroll.addEventListener('scroll', syncScrollHandler);
                }
            }

            // åŒæ­¥æ»šåŠ¨åˆ‡æ¢äº‹ä»¶
            if (syncScroll) {
                syncScroll.addEventListener('change', () => {
                    // ç§»é™¤ç°æœ‰çš„ç›‘å¬å™¨
                    originalScroll && originalScroll.removeEventListener('scroll', syncScrollHandler);
                    comparisonScroll && comparisonScroll.removeEventListener('scroll', syncScrollHandler);
                    
                    if (syncScroll.checked) {
                        // é‡æ–°æ·»åŠ ç›‘å¬å™¨
                        originalScroll && originalScroll.addEventListener('scroll', syncScrollHandler);
                        comparisonScroll && comparisonScroll.addEventListener('scroll', syncScrollHandler);
                    }
                });

                // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–åŒæ­¥æ»šåŠ¨ï¼ˆå¦‚æœé»˜è®¤å‹¾é€‰ï¼‰
                initSyncScroll();
            }

            // æ ¹æ®ç›¸ä¼¼åº¦è®¾ç½®é¢œè‰²
            function setSimilarityColor() {
                const similarityElement = document.querySelector('.similarity-score');
                if (!similarityElement) return;
                
                const similarityText = similarityElement.textContent;
                const similarityMatch = similarityText.match(/(\d+\.?\d*)/);
                if (!similarityMatch) return;
                
                const similarity = parseFloat(similarityMatch[1]);
                
                // ç§»é™¤æ‰€æœ‰ç›¸ä¼¼åº¦ç±»
                similarityElement.classList.remove('similarity-excellent', 'similarity-good', 'similarity-medium', 'similarity-low', 'similarity-very-low');
                
                // æ ¹æ®ç›¸ä¼¼åº¦æ·»åŠ å¯¹åº”ç±»
                if (similarity >= 95) {
                    similarityElement.classList.add('similarity-excellent');
                    similarityElement.title = 'ä¼˜ç§€ï¼šæ–‡æ¡£é«˜åº¦ç›¸ä¼¼';
                } else if (similarity >= 85) {
                    similarityElement.classList.add('similarity-good');
                    similarityElement.title = 'è‰¯å¥½ï¼šæ–‡æ¡£ç›¸ä¼¼åº¦è¾ƒé«˜';
                } else if (similarity >= 70) {
                    similarityElement.classList.add('similarity-medium');
                    similarityElement.title = 'ä¸­ç­‰ï¼šæ–‡æ¡£æœ‰ä¸€å®šç›¸ä¼¼åº¦';
                } else if (similarity >= 50) {
                    similarityElement.classList.add('similarity-low');
                    similarityElement.title = 'è¾ƒä½ï¼šæ–‡æ¡£ç›¸ä¼¼åº¦ä¸é«˜';
                } else {
                    similarityElement.classList.add('similarity-very-low');
                    similarityElement.title = 'å¾ˆä½ï¼šæ–‡æ¡£å·®å¼‚è¾ƒå¤§';
                }
            }

            // åˆå§‹åŒ–ç›¸ä¼¼åº¦é¢œè‰²
            setSimilarityColor();

            // åˆå§‹åŒ–é«˜äº®æ˜¾ç¤ºçŠ¶æ€
            function initHighlights() {
                document.querySelectorAll('.ignore-diff').forEach(checkbox => {
                    const diffId = checkbox.dataset.diffId;
                    const diffType = checkbox.dataset.diffType;
                    const highlights = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                    
                    console.log(`åˆå§‹åŒ–é«˜äº®: diffId=${diffId}, diffType=${diffType}, æ‰¾åˆ°${highlights.length}ä¸ªå…ƒç´ `);
                    
                    // æ ¹æ®å‹¾é€‰æ¡†çŠ¶æ€è®¾ç½®é«˜äº®
                    highlights.forEach(elem => {
                        if (checkbox.checked) {
                            // å…¼å®¹è‹±æ–‡ç±»å‹
                            const typeKey = (diffType === 'ä¿®æ”¹' ? 'modified' : diffType === 'æ–°å¢' ? 'added' : diffType === 'åˆ é™¤' ? 'deleted' : diffType);
                            elem.classList.add(`highlight-${typeKey}`);
                            console.log(`æ·»åŠ é«˜äº®ç±»: highlight-${diffType}`);
                        } else {
                            const typeKey = (diffType === 'ä¿®æ”¹' ? 'modified' : diffType === 'æ–°å¢' ? 'added' : diffType === 'åˆ é™¤' ? 'deleted' : diffType);
                            elem.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                });
            }

            // é«˜äº®åˆ‡æ¢äº‹ä»¶ï¼ˆæŒ‰æ–‡ä»¶ç±»å‹åˆ†æµï¼‰
            function applyHighlightForExcel(e) {
                const diffId = e.target.dataset.diffId;
                const diffType = e.target.dataset.diffType;
                const highlights = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                highlights.forEach(elem => {
                    const typeKey = (diffType === 'ä¿®æ”¹' ? 'modified' : diffType === 'æ–°å¢' ? 'added' : diffType === 'åˆ é™¤' ? 'deleted' : diffType);
                    if (e.target.checked) elem.classList.add(`highlight-${typeKey}`);
                    else elem.classList.remove(`highlight-${typeKey}`);
                });
            }

            function applyHighlightForWord(e) {
                const diffType = e.target.dataset.diffType;
                const startOrig = parseInt(e.target.dataset.startIdxOrig, 10);
                const endOrig = parseInt(e.target.dataset.endIdxOrig, 10);
                const startNew = parseInt(e.target.dataset.startIdxNew, 10);
                const endNew = parseInt(e.target.dataset.endIdxNew, 10);
                const typeKey = (diffType === 'ä¿®æ”¹' ? 'modified' : diffType === 'æ–°å¢' ? 'added' : diffType === 'åˆ é™¤' ? 'deleted' : diffType);

                const origLines = document.querySelectorAll('.original-preview .line-content');
                const newLines = document.querySelectorAll('.comparison-preview .line-content');

                // åˆ é™¤ï¼šä»…åŸæ–‡åŒºé—´
                if (typeKey === 'deleted') {
                    origLines.forEach((el, idx) => {
                        if (idx >= startOrig && idx < endOrig) {
                            e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                    return;
                }

                // æ–°å¢ï¼šä»…æ–°æ–‡åŒºé—´
                if (typeKey === 'added') {
                    newLines.forEach((el, idx) => {
                        if (idx >= startNew && idx < endNew) {
                            e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                        }
                    });
                    return;
                }

                // ä¿®æ”¹ï¼šä¸¤ä¾§åŒºé—´
                origLines.forEach((el, idx) => {
                    if (idx >= startOrig && idx < endOrig) {
                        e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                    }
                });
                newLines.forEach((el, idx) => {
                    if (idx >= startNew && idx < endNew) {
                        e.target.checked ? el.classList.add(`highlight-${typeKey}`) : el.classList.remove(`highlight-${typeKey}`);
                    }
                });
            }

            const container = document.querySelector('.container');
            const fileType = container ? container.getAttribute('data-filetype') : 'text';
            document.querySelectorAll('.ignore-diff').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    if (fileType === 'word') applyHighlightForWord(e);
                    else applyHighlightForExcel(e);
                });
                // åˆæ¬¡åŠ è½½æ—¶åŒæ­¥ä¸€æ¬¡ï¼Œç¡®ä¿å‹¾é€‰çŠ¶æ€ä¸ç±»ä¸€è‡´
                const evt = { target: checkbox };
                if (fileType === 'word') applyHighlightForWord(evt);
                else applyHighlightForExcel(evt);
            });

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é«˜äº®çŠ¶æ€
            setTimeout(() => {
                console.log('å¼€å§‹æ£€æŸ¥DOMç»“æ„...');
                const allDiffElements = document.querySelectorAll('[data-diff-id]');
                console.log(`æ‰¾åˆ° ${allDiffElements.length} ä¸ªå¸¦æœ‰data-diff-idçš„å…ƒç´ `);
                
                const allCheckboxes = document.querySelectorAll('.ignore-diff');
                console.log(`æ‰¾åˆ° ${allCheckboxes.length} ä¸ªé«˜äº®å‹¾é€‰æ¡†`);
                
                allCheckboxes.forEach((checkbox, index) => {
                    const diffId = checkbox.dataset.diffId;
                    const diffType = checkbox.dataset.diffType;
                    const matchingElements = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                    console.log(`å‹¾é€‰æ¡†${index}: diffId=${diffId}, type=${diffType}, æ‰¾åˆ°${matchingElements.length}ä¸ªåŒ¹é…å…ƒç´ `);
                    
                    // æ£€æŸ¥å…·ä½“åœ¨å“ªä¸ªåŒºåŸŸæ‰¾åˆ°äº†å…ƒç´ 
                    const originalElements = document.querySelectorAll(`.original-preview [data-diff-id="${diffId}"]`);
                    const comparisonElements = document.querySelectorAll(`.comparison-preview [data-diff-id="${diffId}"]`);
                    console.log(`  - åŸå§‹æ–‡ä»¶åŒºåŸŸ: ${originalElements.length}ä¸ª, å¯¹æ¯”æ–‡ä»¶åŒºåŸŸ: ${comparisonElements.length}ä¸ª`);
                });
                
                initHighlights();
            }, 1000);

            // è·³è½¬åˆ°å·®å¼‚è¡Œ
            document.querySelectorAll('.diff-box').forEach(box => {
                box.addEventListener('click', () => {
                    const diffId = box.dataset.diffId;
                    console.log(`ç‚¹å‡»å·®å¼‚æ¡†ï¼ŒdiffId: ${diffId}`);
                    
                    const container = document.querySelector('.container');
                    const fileType = container ? container.getAttribute('data-filetype') : 'text';
                    let targetOriginal = null;
                    let targetComparison = null;

                    if (fileType === 'word') {
                        // Wordï¼šä¼˜å…ˆå®šä½åŒºé—´å†…ç¬¬ä¸€ä¸ªå…·æœ‰åŒ¹é…æ–‡æœ¬çš„è¡Œï¼Œå›é€€åˆ°èµ·å§‹è¡Œ
                        const startOrig = parseInt(box.dataset.startIdxOrig, 10);
                        const endOrig = parseInt(box.dataset.endIdxOrig, 10);
                        const startNew = parseInt(box.dataset.startIdxNew, 10);
                        const endNew = parseInt(box.dataset.endIdxNew, 10);
                        const tryFindInRange = (selectorBase, s, e) => {
                            for (let i = s; i < e; i++) {
                                const el = document.querySelector(`${selectorBase}[data-line-num="${i}"]`);
                                if (el && el.textContent && el.textContent.trim()) return el;
                            }
                            return null;
                        };
                        targetOriginal = tryFindInRange('.original-preview .line-content', startOrig, endOrig) || document.querySelector(`.original-preview .line-content[data-line-num="${startOrig}"]`);
                        targetComparison = tryFindInRange('.comparison-preview .line-content', startNew, endNew) || document.querySelector(`.comparison-preview .line-content[data-line-num="${startNew}"]`);
                    } else {
                        // Excelï¼šæ²¿ç”¨ data-diff-id ç²¾ç¡®å®šä½
                        targetOriginal = document.querySelector(`.original-preview .line-content[data-diff-id="${diffId}"]`);
                        targetComparison = document.querySelector(`.comparison-preview .line-content[data-diff-id="${diffId}"]`);
                    }
                    
                    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•æ—§çš„é€‰æ‹©å™¨ä½œä¸ºå¤‡é€‰
                    if (!targetOriginal) targetOriginal = document.querySelector(`.original-preview [data-diff-id="${diffId}"]`);
                    if (!targetComparison) targetComparison = document.querySelector(`.comparison-preview [data-diff-id="${diffId}"]`);
                    
                    console.log(`ğŸ¯ æœ€ç»ˆæ‰¾åˆ° - åŸå§‹è¡Œ: ${targetOriginal ? 'æ˜¯' : 'å¦'}, å¯¹æ¯”è¡Œ: ${targetComparison ? 'æ˜¯' : 'å¦'}`);
                    
                    // è·å–å·®å¼‚ç±»å‹è¿›è¡Œç‰¹æ®Šå¤„ç†
                    const diffTypeBadge = box.querySelector('.diff-type');
                    const diffType = diffTypeBadge && diffTypeBadge.classList.contains('modified') ? 'ä¿®æ”¹'
                        : diffTypeBadge && diffTypeBadge.classList.contains('added') ? 'æ–°å¢'
                        : diffTypeBadge && diffTypeBadge.classList.contains('deleted') ? 'åˆ é™¤'
                        : (box.dataset.diffType || box.querySelector('.diff-type').textContent.trim());
                    console.log(`ğŸ¯ å·®å¼‚ç±»å‹: ${diffType}`);
                    
                    // æ ¹æ®å·®å¼‚ç±»å‹é€‰æ‹©è·³è½¬ç­–ç•¥
                    if (diffType === 'åˆ é™¤') {
                        if (targetOriginal) {
                            targetOriginal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            attemptAdvancedSearch(diffId);
                        }
                    } else if (diffType === 'æ–°å¢') {
                        if (targetComparison) {
                            targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            attemptAdvancedSearch(diffId);
                        }
                    } else {
                        if (fileType === 'word') {
                            // Wordï¼šä¼˜å…ˆæ»šåŠ¨åˆ°åŒºé—´èµ·å§‹è¡Œï¼Œä¿æŒä¸¤ä¾§ä¸€è‡´
                            const startOrig = parseInt(box.dataset.startIdxOrig, 10);
                            const startNew = parseInt(box.dataset.startIdxNew, 10);
                            const oEl = document.querySelector(`.original-preview .line-content[data-line-num="${startOrig}"]`);
                            const nEl = document.querySelector(`.comparison-preview .line-content[data-line-num="${startNew}"]`);
                            if (oEl) oEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            else if (nEl) nEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            else attemptAdvancedSearch(diffId);
                        } else {
                            if (targetOriginal) {
                                targetOriginal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                const syncScrollEnabled = document.getElementById('sync-scroll').checked;
                                if (!syncScrollEnabled && targetComparison) {
                                    setTimeout(() => {
                                        targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 100);
                                }
                            } else if (targetComparison) {
                                targetComparison.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                attemptAdvancedSearch(diffId);
                            }
                        }
                    }
                });
            });

            // é«˜çº§æœç´¢å‡½æ•°ï¼šå½“å¸¸è§„æ–¹æ³•æ‰¾ä¸åˆ°å…ƒç´ æ—¶ä½¿ç”¨
            function attemptAdvancedSearch(diffId) {
                console.log(`ğŸ” å¼€å§‹é«˜çº§æœç´¢ï¼ŒdiffId: ${diffId}`);
                
                // æœç´¢ç­–ç•¥1ï¼šé€šè¿‡åŒ…å«data-diff-idçš„ä»»ä½•å…ƒç´ 
                const allElements = document.querySelectorAll(`[data-diff-id="${diffId}"]`);
                console.log(`ğŸ” ç­–ç•¥1æ‰¾åˆ° ${allElements.length} ä¸ªå…ƒç´ `);
                
                if (allElements.length > 0) {
                    const firstElement = allElements[0];
                    firstElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // æœç´¢ç­–ç•¥2ï¼šé€šè¿‡å·®å¼‚åˆ—è¡¨é¡¹æŸ¥æ‰¾ç›¸å…³å…ƒç´ 
                const diffBoxes = document.querySelectorAll(`.diff-box[data-diff-id="${diffId}"]`);
                console.log(`ğŸ” ç­–ç•¥2æ‰¾åˆ° ${diffBoxes.length} ä¸ªå·®å¼‚æ¡†`);
                
                if (diffBoxes.length > 0) {
                    diffBoxes[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // æœ€åçš„æç¤º
                console.log('ğŸ” æ‰€æœ‰æœç´¢ç­–ç•¥éƒ½å¤±è´¥äº†');
                alert('æ— æ³•å®šä½åˆ°å¯¹åº”çš„å·®å¼‚ä½ç½®ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºDOMç»“æ„é—®é¢˜ã€‚è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚');
            }

            // å±•å¼€/æ”¶èµ·å·®å¼‚å†…å®¹
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = btn.previousElementSibling;
                    content.classList.toggle('expanded');
                    btn.textContent = content.classList.contains('expanded') ? 'æ”¶èµ·' : 'å±•å¼€';
                });
            });
        });
    </script>
</head>
<body>
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    {% if results %}
    <div class="container" data-filetype="{% set _ext = (results.original_filename or '')|lower %}{% if _ext.endswith('.doc') or _ext.endswith('.docx') %}word{% elif _ext.endswith('.xls') or _ext.endswith('.xlsx') %}excel{% else %}text{% endif %}">
        <div class="left-panel">
            <div class="top-header">
                <h1>æ–‡ä»¶æ¯”å¯¹ç»“æœ</h1>
                <div class="top-right-controls">
                    <div class="similarity-score">
                        ç›¸ä¼¼åº¦: {{ results.similarity }}%
                    </div>
                    <div class="controls">
                        <div class="checkbox-container">
                            <input type="checkbox" id="sync-scroll" checked>
                            <label for="sync-scroll">åŒæ­¥æ»šåŠ¨</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-container">
                <div class="preview original-preview">
                    <div class="file-header">
                        <div class="file-name">åŸå§‹æ–‡ä»¶: {{ results.original_filename }}</div>
                    </div>
                    <div class="file-content">
                        {% for line in results.original_lines %}
                            {% set idx = loop.index0 %}
                            {% set diff = results.differences | selectattr('start_idx_orig','le', idx) | selectattr('end_idx_orig','gt', idx) | first %}
                            <div class="line-content{% if diff %} highlight-{{ diff.type }}{% endif %}"
                                 data-line-num="{{ idx }}"{% if diff %} data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"{% endif %}>{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="preview comparison-preview">
                    <div class="file-header">
                        <div class="file-name">æ¯”å¯¹æ–‡ä»¶: {{ results.comparison_filename }}</div>
                    </div>
                    <div class="file-content">
                        {% for line in results.comparison_lines %}
                            {% set idx = loop.index0 %}
                            {% set diff = results.differences | selectattr('start_idx_new','le', idx) | selectattr('end_idx_new','gt', idx) | first %}
                            <div class="line-content{% if diff %} highlight-{{ diff.type }}{% endif %}"
                                 data-line-num="{{ idx }}"{% if diff %} data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"{% endif %}>{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="fixed-header">
                <div class="section-title">
                    æ–‡ä»¶å·®å¼‚ ({{ results.differences|length }} å¤„)
                </div>
            </div>
            
            <div class="diff-list">
                {% for diff in results.differences %}
                    <div class="diff-box" data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"
                         data-start-idx-orig="{{ diff.start_idx_orig }}" data-end-idx-orig="{{ diff.end_idx_orig }}"
                         data-start-idx-new="{{ diff.start_idx_new }}" data-end-idx-new="{{ diff.end_idx_new }}">
                        <div class="diff-type {{ diff.type }}">
                            {% if diff.type == 'modified' %}ä¿®æ”¹
                            {% elif diff.type == 'added' %}æ–°å¢
                            {% elif diff.type == 'deleted' %}åˆ é™¤
                            {% endif %}
                        </div>
                        <div class="diff-content">
                            {% if diff.type == 'modified' %}
                                <strong>åŸæ–‡:</strong> {{ diff.original }}<br>
                                <strong>æ–°æ–‡:</strong> {{ diff.new }}
                            {% elif diff.type == 'added' %}
                                <strong>æ–°å¢å†…å®¹:</strong> {{ diff.new }}
                            {% elif diff.type == 'deleted' %}
                                <strong>åˆ é™¤å†…å®¹:</strong> {{ diff.original }}
                            {% endif %}
                        </div>
                        {% if (diff.original and diff.original|length > 100) or (diff.new and diff.new|length > 100) %}
                            <button class="expand-btn">å±•å¼€</button>
                        {% endif %}
                        <div class="checkbox-container" style="margin-top: 8px;">
                            <input type="checkbox" class="ignore-diff" data-diff-id="{{ diff.id }}" data-diff-type="{{ diff.type }}"
                                   data-start-idx-orig="{{ diff.start_idx_orig }}" data-end-idx-orig="{{ diff.end_idx_orig }}"
                                   data-start-idx-new="{{ diff.start_idx_new }}" data-end-idx-new="{{ diff.end_idx_new }}" checked>
                            <label>é«˜äº®æ˜¾ç¤º</label>
                        </div>
                    </div>
                {% endfor %}
                
                {% if not results.differences %}
                    <div style="text-align: center; color: #6c757d; padding: 40px;">
                        <p>æœªå‘ç°å·®å¼‚</p>
                        <p>ä¸¤ä¸ªæ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒ</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
        <div style="text-align: center; padding: 40px;">
            <h1>æ–‡ä»¶æ¯”å¯¹</h1>
            <p><a href="/">è¿”å›ä¸Šä¼ é¡µé¢</a></p>
        </div>
    {% endif %}
    
    <!-- ç»“æœé¡µé¢ä¿æŠ¤è„šæœ¬ - é˜²æ­¢æ„å¤–åˆ·æ–°å’Œè¡¨å•é‡å¤æäº¤ -->
    <script>
    // é˜²æ­¢è¡¨å•é‡å¤æäº¤å’Œç»“æœä¸¢å¤±çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ
    (function() {
        // é¡µé¢çŠ¶æ€ç®¡ç†
        let pageLoaded = true;
        let isLeavingIntentionally = false;
        
        // åˆ›å»ºç¾è§‚çš„ç¡®è®¤å¯¹è¯æ¡†
        function showCustomConfirm(title, message, onConfirm, onCancel) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 90%;
                text-align: center;
                animation: fadeIn 0.3s ease;
            `;
            
            dialog.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 20px;">${title}</h3>
                    <p style="margin: 0; color: #666; line-height: 1.5; font-size: 16px;">${message}</p>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="confirmBtn" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background 0.3s;
                    ">ç¡®è®¤ç¦»å¼€</button>
                    <button id="cancelBtn" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background 0.3s;
                    ">å–æ¶ˆ</button>
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: scale(0.9); }
                    to { opacity: 1; transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('confirmBtn').onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                if (onConfirm) onConfirm();
            };
            
            document.getElementById('cancelBtn').onclick = function() {
                document.body.removeChild(modal);
                document.head.removeChild(style);
                if (onCancel) onCancel();
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                    if (onCancel) onCancel();
                }
            };
            
            // ESCé”®å…³é—­
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.head.removeChild(style);
                    document.removeEventListener('keydown', escHandler);
                    if (onCancel) onCancel();
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // ç›‘å¬é¡µé¢åˆ·æ–°/å…³é—­äº‹ä»¶
        window.addEventListener('beforeunload', function(e) {
            if (pageLoaded && !isLeavingIntentionally) {
                // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ›¿ä»£é»˜è®¤æµè§ˆå™¨æç¤º
                e.preventDefault();
                e.returnValue = ''; // ç°ä»£æµè§ˆå™¨è¦æ±‚è¿”å›ç©ºå­—ç¬¦ä¸²
                
                // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
                showCustomConfirm(
                    'âš ï¸ ç¦»å¼€é¡µé¢ç¡®è®¤',
                    'ç¦»å¼€æ­¤é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦ç¦»å¼€é¡µé¢å—ï¼Ÿ</strong>',
                    function() {
                        // ç”¨æˆ·ç¡®è®¤ç¦»å¼€
                        isLeavingIntentionally = true;
                        // ä¸æ‰§è¡Œå…·ä½“æ“ä½œï¼Œè®©æµè§ˆå™¨è‡ªç„¶å¤„ç†
                    },
                    function() {
                        // ç”¨æˆ·å–æ¶ˆç¦»å¼€
                        console.log('ç”¨æˆ·å–æ¶ˆäº†ç¦»å¼€é¡µé¢');
                    }
                );
                
                return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²ä»¥é˜»æ­¢é»˜è®¤è¡Œä¸º
            }
        });
        
        // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶
        window.addEventListener('unload', function() {
            pageLoaded = false;
        });
        
        // DOMåŠ è½½å®Œæˆåçš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // é˜»æ­¢æ‰€æœ‰è¡¨å•çš„æ„å¤–æäº¤
            const forms = document.querySelectorAll('form');
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    showCustomConfirm(
                        'é‡æ–°æäº¤ç¡®è®¤',
                        'æ­¤é¡µé¢ä¸ºç»“æœå±•ç¤ºé¡µé¢ï¼Œé‡æ–°æäº¤å°†é‡å¤æ‰§è¡Œæ¯”å¯¹ä»»åŠ¡ï¼Œæµªè´¹æœåŠ¡å™¨èµ„æºã€‚<br><br><strong>å»ºè®®ï¼š</strong>å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µã€‚',
                        function() {
                            // ç”¨æˆ·ç¡®è®¤é‡æ–°æäº¤
                            isLeavingIntentionally = true;
                            form.submit();
                        }
                    );
                    return false;
                });
            });
            
            // ä¸ºè¿”å›é“¾æ¥æ·»åŠ å¤„ç†
            const backLinks = document.querySelectorAll('a[href="/"], a[href="' + window.location.origin + '/"]');
            backLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    isLeavingIntentionally = true;
                    pageLoaded = false;
                });
            });
            
            // æ·»åŠ é¡µé¢é¡¶éƒ¨æç¤ºæ¡
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 8px 0;
                text-align: center;
                font-size: 14px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            notice.innerHTML = `
                <span style="margin-right: 10px;">ğŸ’¡</span>
                <strong>æç¤ºï¼š</strong>æ­¤é¡µé¢ä¸ºæ¯”å¯¹ç»“æœå±•ç¤ºé¡µé¢ï¼Œåˆ·æ–°å°†å¯¼è‡´ç»“æœä¸¢å¤±
                <span style="margin-left: 15px; font-size: 12px; opacity: 0.9;">å¦‚éœ€æ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ</span>
            `;
            
            document.body.appendChild(notice);
            
            // è°ƒæ•´é¡µé¢å†…å®¹çš„ä¸Šè¾¹è·ï¼Œé¿å…è¢«æç¤ºæ¡é®æŒ¡
            const body = document.body;
            if (body) {
                body.style.paddingTop = '50px';
            }
        });
        
        // é”®ç›˜å¿«æ·é”®å¤„ç†
        document.addEventListener('keydown', function(e) {
            // F5 æˆ– Ctrl+R åˆ·æ–°æ—¶çš„ç¡®è®¤
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                showCustomConfirm(
                    'ğŸ”„ åˆ·æ–°é¡µé¢ç¡®è®¤',
                    'åˆ·æ–°é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦åˆ·æ–°é¡µé¢å—ï¼Ÿ</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        location.reload();
                    }
                );
                return false;
            }
            
            // Ctrl+W å…³é—­æ ‡ç­¾é¡µæ—¶çš„ç¡®è®¤
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                showCustomConfirm(
                    'âŒ å…³é—­é¡µé¢ç¡®è®¤',
                    'å…³é—­é¡µé¢å°†å¯¼è‡´æ¯”å¯¹ç»“æœæ°¸ä¹…ä¸¢å¤±ï¼<br><br><strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>â€¢ å¦‚éœ€ä¿å­˜ç»“æœï¼Œè¯·å…ˆæˆªå›¾æˆ–å¤åˆ¶é‡è¦ä¿¡æ¯<br>â€¢ å¦‚éœ€è¿›è¡Œæ–°çš„æ¯”å¯¹ï¼Œè¯·è¿”å›é¦–é¡µ<br><br><strong>âš ï¸ ç¡®å®šè¦å…³é—­é¡µé¢å—ï¼Ÿ</strong>',
                    function() {
                        isLeavingIntentionally = true;
                        window.close();
                    }
                );
                return false;
            }
        });
        
        // æµè§ˆå™¨å†å²ç®¡ç†
        if (window.history && window.history.replaceState) {
            // æ›¿æ¢å½“å‰å†å²çŠ¶æ€ï¼Œé¿å…è¡¨å•é‡æ–°æäº¤
            const newUrl = window.location.href.split('?')[0];
            window.history.replaceState(
                { page: 'result' }, 
                document.title, 
                newUrl
            );
        }
        
        console.log('ğŸ›¡ï¸ ç»“æœé¡µé¢ä¿æŠ¤å·²å¯ç”¨ï¼šé˜²æ­¢æ„å¤–åˆ·æ–°ã€è¡¨å•é‡å¤æäº¤å’Œç»“æœä¸¢å¤±');
    })();
    </script>
</body>
</html>